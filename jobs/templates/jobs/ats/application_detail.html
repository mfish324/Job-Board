{% extends 'jobs/base.html' %}

{% block title %}Application - {{ application.applicant.get_full_name|default:application.applicant.username }} - Real Jobs, Real People{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a href="{% url 'employer_dashboard' %}">Dashboard</a></li>
                            {% if is_employer %}
                            <li class="breadcrumb-item"><a href="{% url 'ats_pipeline' application.job.id %}">Pipeline</a></li>
                            {% endif %}
                            <li class="breadcrumb-item active">Application</li>
                        </ol>
                    </nav>
                    <h1 class="fw-bold mb-0">
                        <i class="bi bi-person-badge text-primary me-2"></i>
                        {{ application.applicant.get_full_name|default:application.applicant.username }}
                    </h1>
                </div>
                {% if is_employer %}
                <a href="{% url 'ats_pipeline' application.job.id %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Pipeline
                </a>
                {% else %}
                <a href="{% url 'user_profile' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Profile
                </a>
                {% endif %}
            </div>

            <!-- Job Info Card -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-briefcase me-2 text-primary"></i>Position Applied For</h5>
                </div>
                <div class="card-body">
                    <h4 class="mb-2">{{ application.job.title }}</h4>
                    <div class="d-flex flex-wrap gap-3">
                        <span><i class="bi bi-building text-muted me-1"></i>{{ application.job.company }}</span>
                        <span><i class="bi bi-geo-alt text-muted me-1"></i>{{ application.job.location }}</span>
                        <span><i class="bi bi-calendar text-muted me-1"></i>Applied {{ application.applied_date|date:"M d, Y" }}</span>
                    </div>
                </div>
            </div>

            <!-- Applicant Info Card -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-person me-2 text-primary"></i>Applicant Information</h5>
                        <!-- Verification Badges -->
                        <div class="d-flex gap-1">
                            {% if application.applicant.userprofile.is_email_verified %}
                            <span class="badge bg-success" title="Email Verified">
                                <i class="bi bi-envelope-check"></i>
                            </span>
                            {% endif %}
                            {% if application.applicant.userprofile.is_phone_verified %}
                            <span class="badge bg-success" title="Phone Verified">
                                <i class="bi bi-phone-fill"></i>
                            </span>
                            {% endif %}
                            {% if application.applicant.userprofile.has_linkedin %}
                            <span class="badge bg-primary" title="LinkedIn Added">
                                <i class="bi bi-linkedin"></i>
                            </span>
                            {% endif %}
                            {% if not application.applicant.userprofile.is_verified %}
                            <span class="badge bg-warning text-dark" title="Not Verified">
                                <i class="bi bi-exclamation-triangle"></i> Unverified
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Verification Status Row -->
                    {% if is_employer %}
                    <div class="alert {% if application.applicant.userprofile.get_verification_level == 'complete' %}alert-success{% elif application.applicant.userprofile.get_verification_level == 'enhanced' %}alert-info{% elif application.applicant.userprofile.get_verification_level == 'basic' %}alert-warning{% else %}alert-secondary{% endif %} py-2 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <strong>Verification Level:</strong>
                                {% if application.applicant.userprofile.get_verification_level == 'complete' %}
                                <span class="ms-1"><i class="bi bi-patch-check-fill"></i> Complete</span>
                                {% elif application.applicant.userprofile.get_verification_level == 'enhanced' %}
                                <span class="ms-1"><i class="bi bi-shield-fill-check"></i> Enhanced</span>
                                {% elif application.applicant.userprofile.get_verification_level == 'basic' %}
                                <span class="ms-1"><i class="bi bi-shield-check"></i> Basic</span>
                                {% else %}
                                <span class="ms-1"><i class="bi bi-shield"></i> Not Verified</span>
                                {% endif %}
                            </span>
                            <span class="small">
                                {% if application.applicant.userprofile.is_email_verified %}<i class="bi bi-envelope-check text-success me-2" title="Email Verified"></i>{% endif %}
                                {% if application.applicant.userprofile.is_phone_verified %}<i class="bi bi-phone-fill text-success me-2" title="Phone Verified"></i>{% endif %}
                                {% if application.applicant.userprofile.has_linkedin %}<i class="bi bi-linkedin text-primary" title="LinkedIn Added"></i>{% endif %}
                            </span>
                        </div>
                    </div>
                    {% endif %}

                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-envelope me-2"></i>Email:</strong>
                            <p class="mb-0">
                                {{ application.applicant.email }}
                                {% if application.applicant.userprofile.is_email_verified %}
                                <i class="bi bi-check-circle-fill text-success ms-1" title="Verified"></i>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-telephone me-2"></i>Phone:</strong>
                            <p class="mb-0">
                                {{ application.applicant.userprofile.phone|default:"Not provided" }}
                                {% if application.applicant.userprofile.is_phone_verified %}
                                <i class="bi bi-check-circle-fill text-success ms-1" title="Verified"></i>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    {% if application.applicant.userprofile.linkedin_url %}
                    <div class="mb-3">
                        <strong><i class="bi bi-linkedin me-2"></i>LinkedIn:</strong>
                        <a href="{{ application.applicant.userprofile.linkedin_url }}" target="_blank" class="ms-2">
                            <i class="bi bi-box-arrow-up-right me-1"></i>View Profile
                        </a>
                    </div>
                    {% endif %}

                    {% if application.applicant.userprofile.skills %}
                    <div class="mb-3">
                        <strong><i class="bi bi-lightbulb me-2"></i>Skills:</strong>
                        <p class="mb-0">{{ application.applicant.userprofile.skills }}</p>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <strong><i class="bi bi-briefcase me-2"></i>Experience:</strong>
                        <span>{{ application.applicant.userprofile.experience_years }} years</span>
                    </div>

                    {% if application.cover_letter %}
                    <div class="mt-4">
                        <h6 class="fw-bold mb-3"><i class="bi bi-file-text me-2"></i>Cover Letter</h6>
                        <div class="bg-light p-3 rounded" style="white-space: pre-wrap; border-left: 4px solid var(--primary-color);">{{ application.cover_letter }}</div>
                    </div>
                    {% endif %}

                    {% if application.get_resume and is_employer %}
                    <div class="mt-4">
                        <a href="{% url 'download_resume' application.id %}" class="btn btn-primary">
                            <i class="bi bi-download me-2"></i>Download Resume
                        </a>
                    </div>
                    {% endif %}

                    {% if is_employer %}
                    <!-- Communication Actions -->
                    <div class="mt-4 pt-4 border-top">
                        <h6 class="fw-bold mb-3"><i class="bi bi-chat-dots me-2"></i>Communication</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="{% url 'application_messages' application.id %}" class="btn btn-outline-primary">
                                <i class="bi bi-chat-left-text me-1"></i>Messages
                                {% if application.messages.count > 0 %}
                                <span class="badge bg-primary">{{ application.messages.count }}</span>
                                {% endif %}
                            </a>
                            <a href="{% url 'send_email_to_applicant' application.id %}" class="btn btn-outline-secondary">
                                <i class="bi bi-envelope me-1"></i>Send Email
                            </a>
                            <a href="{% url 'application_email_history' application.id %}" class="btn btn-outline-secondary">
                                <i class="bi bi-clock-history me-1"></i>Email History
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if is_employer %}
            <!-- Notes Section -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-sticky me-2 text-primary"></i>Notes</h5>
                    <span class="badge bg-secondary">{{ notes|length }}</span>
                </div>
                <div class="card-body">
                    <!-- Add Note Form -->
                    <form method="post" action="{% url 'add_application_note' application.id %}" class="mb-4">
                        {% csrf_token %}
                        <div class="mb-3">
                            <textarea name="content" class="form-control" rows="3" placeholder="Add a note about this candidate..."></textarea>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="is_private" id="is_private">
                                <label class="form-check-label" for="is_private">
                                    <i class="bi bi-lock me-1"></i>Private note (only visible to you)
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus me-1"></i>Add Note
                            </button>
                        </div>
                    </form>

                    <!-- Notes List -->
                    {% for note in notes %}
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ note.author.get_full_name|default:note.author.username }}</strong>
                                {% if note.is_private %}
                                <span class="badge bg-secondary ms-2"><i class="bi bi-lock"></i> Private</span>
                                {% endif %}
                                <br>
                                <small class="text-muted">{{ note.created_at|date:"M d, Y g:i A" }}</small>
                            </div>
                            {% if note.author == user %}
                            <form method="post" action="{% url 'delete_application_note' note.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this note?');">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        <p class="mb-0 mt-2">{{ note.content }}</p>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">No notes yet. Add one above!</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Stage History -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2 text-primary"></i>Stage History</h5>
                </div>
                <div class="card-body">
                    {% if stage_history %}
                    <ul class="list-unstyled">
                        {% for history in stage_history %}
                        <li class="d-flex mb-3">
                            <div class="me-3">
                                <span class="stage-indicator" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: {{ history.stage.color|default:'#6c757d' }};"></span>
                            </div>
                            <div>
                                <strong>{{ history.stage.name|default:"Unknown" }}</strong>
                                <br>
                                <small class="text-muted">
                                    {{ history.changed_at|date:"M d, Y g:i A" }}
                                    {% if history.changed_by %}by {{ history.changed_by.get_full_name|default:history.changed_by.username }}{% endif %}
                                </small>
                                {% if history.notes %}
                                <p class="mb-0 mt-1 text-muted">{{ history.notes }}</p>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted text-center">No stage changes recorded yet.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            {% if is_employer %}
            <!-- Current Stage Card -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-signpost me-2 text-primary"></i>Current Stage</h5>
                </div>
                <div class="card-body">
                    {% if application.current_stage %}
                    <div class="d-flex align-items-center mb-3">
                        <span class="stage-indicator me-2" style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background-color: {{ application.current_stage.color }};"></span>
                        <h4 class="mb-0">{{ application.current_stage.name }}</h4>
                    </div>
                    {% endif %}

                    <form method="post" action="{% url 'move_application_stage' application.id %}">
                        {% csrf_token %}
                        <label class="form-label">Move to Stage:</label>
                        <select name="stage_id" class="form-select mb-2">
                            {% for stage in stages %}
                            <option value="{{ stage.id }}" {% if stage.id == application.current_stage_id %}selected{% endif %}>
                                {{ stage.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <textarea name="notes" class="form-control mb-2" rows="2" placeholder="Add a note (optional)"></textarea>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-arrow-right me-1"></i>Move Stage
                        </button>
                    </form>
                </div>
            </div>

            <!-- Rating Card -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-star me-2 text-primary"></i>Rating</h5>
                    {% if average_rating %}
                    <span class="badge bg-warning text-dark fs-6">
                        <i class="bi bi-star-fill"></i> {{ average_rating }}/5
                    </span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'rate_application' application.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Overall Rating <span class="text-danger">*</span></label>
                            <select name="overall_rating" class="form-select" required>
                                <option value="">Select rating...</option>
                                {% for value, label in "1:1 - Poor,2:2 - Below Average,3:3 - Average,4:4 - Good,5:5 - Excellent"|make_list %}
                                {% endfor %}
                                <option value="1" {% if user_rating.overall_rating == 1 %}selected{% endif %}>1 - Poor</option>
                                <option value="2" {% if user_rating.overall_rating == 2 %}selected{% endif %}>2 - Below Average</option>
                                <option value="3" {% if user_rating.overall_rating == 3 %}selected{% endif %}>3 - Average</option>
                                <option value="4" {% if user_rating.overall_rating == 4 %}selected{% endif %}>4 - Good</option>
                                <option value="5" {% if user_rating.overall_rating == 5 %}selected{% endif %}>5 - Excellent</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Skills</label>
                            <select name="skills_rating" class="form-select">
                                <option value="">Optional...</option>
                                <option value="1" {% if user_rating.skills_rating == 1 %}selected{% endif %}>1 - Poor</option>
                                <option value="2" {% if user_rating.skills_rating == 2 %}selected{% endif %}>2 - Below Average</option>
                                <option value="3" {% if user_rating.skills_rating == 3 %}selected{% endif %}>3 - Average</option>
                                <option value="4" {% if user_rating.skills_rating == 4 %}selected{% endif %}>4 - Good</option>
                                <option value="5" {% if user_rating.skills_rating == 5 %}selected{% endif %}>5 - Excellent</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Experience</label>
                            <select name="experience_rating" class="form-select">
                                <option value="">Optional...</option>
                                <option value="1" {% if user_rating.experience_rating == 1 %}selected{% endif %}>1 - Poor</option>
                                <option value="2" {% if user_rating.experience_rating == 2 %}selected{% endif %}>2 - Below Average</option>
                                <option value="3" {% if user_rating.experience_rating == 3 %}selected{% endif %}>3 - Average</option>
                                <option value="4" {% if user_rating.experience_rating == 4 %}selected{% endif %}>4 - Good</option>
                                <option value="5" {% if user_rating.experience_rating == 5 %}selected{% endif %}>5 - Excellent</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Culture Fit</label>
                            <select name="culture_fit_rating" class="form-select">
                                <option value="">Optional...</option>
                                <option value="1" {% if user_rating.culture_fit_rating == 1 %}selected{% endif %}>1 - Poor</option>
                                <option value="2" {% if user_rating.culture_fit_rating == 2 %}selected{% endif %}>2 - Below Average</option>
                                <option value="3" {% if user_rating.culture_fit_rating == 3 %}selected{% endif %}>3 - Average</option>
                                <option value="4" {% if user_rating.culture_fit_rating == 4 %}selected{% endif %}>4 - Good</option>
                                <option value="5" {% if user_rating.culture_fit_rating == 5 %}selected{% endif %}>5 - Excellent</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Comments</label>
                            <textarea name="comments" class="form-control" rows="2">{{ user_rating.comments|default:"" }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-star me-1"></i>{% if user_rating %}Update{% else %}Submit{% endif %} Rating
                        </button>
                    </form>
                </div>
            </div>

            <!-- Tags Card -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-tags me-2 text-primary"></i>Tags</h5>
                </div>
                <div class="card-body">
                    <!-- Current Tags -->
                    <div class="mb-3">
                        {% for tag in tags %}
                        <span class="badge me-1 mb-1" style="background-color: {{ tag.color }};">
                            {{ tag.name }}
                            <form method="post" action="{% url 'manage_application_tags' application.id %}" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="remove">
                                <input type="hidden" name="tag_id" value="{{ tag.id }}">
                                <button type="submit" class="btn-close btn-close-white ms-1" style="font-size: 0.6rem;" aria-label="Remove"></button>
                            </form>
                        </span>
                        {% empty %}
                        <p class="text-muted mb-0">No tags assigned</p>
                        {% endfor %}
                    </div>

                    <!-- Add Tag -->
                    <form method="post" action="{% url 'manage_application_tags' application.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add">
                        <div class="input-group">
                            <select name="tag_id" class="form-select">
                                <option value="">Add tag...</option>
                                {% for tag in all_tags %}
                                <option value="{{ tag.id }}">{{ tag.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </form>
                    <a href="{% url 'manage_tags' %}" class="small text-muted">Manage tag library</a>
                </div>
            </div>
            {% else %}
            <!-- Status Card for Job Seekers -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-flag me-2 text-primary"></i>Application Status</h5>
                </div>
                <div class="card-body text-center">
                    <span class="badge fs-5
                        {% if application.status == 'accepted' %}bg-success
                        {% elif application.status == 'rejected' %}bg-danger
                        {% elif application.status == 'reviewed' %}bg-info
                        {% else %}bg-secondary{% endif %}">
                        {{ application.get_status_display }}
                    </span>
                    {% if application.current_stage %}
                    <p class="text-muted mt-2 mb-0">
                        Stage: {{ application.current_stage.name }}
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
